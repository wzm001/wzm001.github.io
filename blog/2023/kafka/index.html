<!DOCTYPE html> <html lang="cn"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Kafka 介绍 | Jimmy Wu</title> <meta name="author" content="Jimmy Wu"> <meta name="description" content="介绍 Kafka 的架构特点和使用场景"> <meta name="keywords" content="Java, 后端, Software Developer"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/icon.png#%20the%20emoji%20used%20as%20the%20favicon%20(alternatively,%20provide%20image%20name%20in%20/assets/img/)"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://wzm001.github.io//blog/2023/kafka/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Jimmy Wu</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">关于我</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">博客<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">项目</a> </li> <li class="nav-item "> <a class="nav-link" href="/assets/pdf/cv.pdf">简历</a> </li> <li class="nav-item "> <a class="nav-link" href="/assets/pdf/ecv.pdf">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Kafka 介绍</h1> <p class="post-meta">April 10, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/mq"> <i class="fas fa-hashtag fa-sm"></i> MQ</a>   <a href="/blog/tag/kafka"> <i class="fas fa-hashtag fa-sm"></i> Kafka</a>     ·   <a href="/blog/category/mq"> <i class="fas fa-tag fa-sm"></i> MQ</a>   <a href="/blog/category/%E5%BE%AE%E6%9C%8D%E5%8A%A1"> <i class="fas fa-tag fa-sm"></i> 微服务</a>   </p> </header> <article class="post-content"> <p><a href="https://kafka.apache.org/" rel="external nofollow noopener" target="_blank">Kafka</a> 是目前除 RabbitMQ 之外另一个使用广泛的消息队列（RocketMQ 在基本架构上借鉴了 Kafka）。Kafka 采用了和 RabbitMQ 完全不同的实现方式，相比 RabbitMQ， Kafka 提供了更高的吞吐量和完善的高可用机制。</p> <p>Kafka 其实并不算是传统意义上的 MQ，它对 MQ 的支持是它功能的一个子集。相比于传统意义上的 MQ 系统，Kafka 更专注于高效地 <em>传递和转换</em> 消息，更像是一个<a href="https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Kafka%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98/01%20%20%E6%B6%88%E6%81%AF%E5%BC%95%E6%93%8E%E7%B3%BB%E7%BB%9FABC.md" rel="external nofollow noopener" target="_blank">消息引擎</a>。</p> <p>Kafka 的一些核心概念：</p> <h3 id="topic-主题">Topic 主题</h3> <p>主题用于分类消息，每个消息都有一个特定的主题，主题使用 name 进行区分。下游消费者订阅不同的主题，获取不同类型的消息。</p> <h3 id="partition-分区">Partition 分区</h3> <p>分区用于保存消息。每个主题至少包含一个分区，通常是包含多个分区，序号从 0 开始。分区可以跨服务器，因此分区能显著提高 Kafka 的吞吐量。主题在逻辑层面区分消息，分区则是在物理层面保存消息。分区底层还会细分为 Segment，分段用于优化分区的保存逻辑，防止分区保存的消息太大，影响读取和清理的性能。分段在客户端层面是透明的；</p> <p>分区支持多副本。一个主分区可以配置多个从分区，从分区负责主动备份主分区的数据，实现故障转移。</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kafka-partition.webp-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kafka-partition.webp-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kafka-partition.webp-1400.webp"></source> <img src="/assets/img/kafka-partition.webp" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h3 id="event-or-message-消息">Event Or Message 消息</h3> <p>消息是业务产生的数据。Kafka 的消息主要包含以下内容：</p> <ul> <li>Key：消息键。Kafka 用 key 来确定消息保存到哪个分区。如果 key 为 null，Kafka 就使用轮询的方式保存消息到不同的分区，否则就根据 Hash 算法计算分区位置。</li> <li>Value：消息体。业务数据，通常经过了压缩；</li> <li>Timestamp：时间戳。消息创建的时间，通常是客户端自动生成，也可以手动指定；</li> <li>Compression type：压缩类型。标记消息体的压缩算法，如 <code class="language-plaintext highlighter-rouge">gzip</code>、<code class="language-plaintext highlighter-rouge">lz4</code>、<code class="language-plaintext highlighter-rouge">snappy</code>、<code class="language-plaintext highlighter-rouge">zstd</code> 或 <code class="language-plaintext highlighter-rouge">none</code>；</li> <li>Headers：消息头，通常指定一些额外信息，可以为空；</li> <li>Topic &amp; Partition number &amp; Offset id：消息一旦写入 Kafka，就会自动带上这三个参数。这三个参数用来唯一定位一条消息；</li> </ul> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kafka-msg.webp-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kafka-msg.webp-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kafka-msg.webp-1400.webp"></source> <img src="/assets/img/kafka-msg.webp" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h3 id="offset-偏移量">Offset 偏移量</h3> <p>偏移量用来标记消息在分区中的位置。偏移量是一个从 0 开始递增的数字。</p> <h3 id="broker-服务实例">Broker 服务实例</h3> <p>Broker 是一台运行着 Kafka 服务的服务器。Kafka 集群包含多个 Broker，每个 Broker 包含一些主题和分区。</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kafka-cluster-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kafka-cluster-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kafka-cluster-1400.webp"></source> <img src="/assets/img/kafka-cluster.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h3 id="consumer-group-消费者组">Consumer Group 消费者组</h3> <p><a href="https://www.conduktor.io/kafka/kafka-consumer-groups-and-consumer-offsets/" rel="external nofollow noopener" target="_blank">消费者</a> 组是 Kafka 用于支持点对点模式引入的概念。一个消费者组下面包含多个 consumer，这些 consumer 都消费同一个主题下的消息，不同的 consumer 消费不同的 partition。每个 partition 只能被一个 consumer 消费，但一个 consumer 可以消费多个 partition，该机制确保 Topic 下的每条消息只能被 Consumer group 中的一个消费者消费。（但可以被多个消费者组消费）</p> <p>如果主题下面的分区数大于消费者组下面的服务实例，那么有些消费者就会消费多个分区的消息。如果两者正好相等，那么每个消费者消费一个分区。如果分区数小于消费者数，那么有些消费者就无法消费，只有等到其他消费者宕机或网络故障导致消费失败后，其他消费者才能顶替原来的消费者进行消费。</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/consumer-group-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/consumer-group-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/consumer-group-1400.webp"></source> <img src="/assets/img/consumer-group.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h2 id="kafka-高性能的原因">Kafka 高性能的原因</h2> <p>Kafka 最大的特点就是其超高的吞吐量，RabbitMQ 的吞吐量是万级，Kafka 吞吐量在十万级。这主要归功于 Kafka 独特的设计，主要有以下几点：</p> <h3 id="磁盘顺序读写">磁盘顺序读写</h3> <p>磁盘的顺序读写性能比随机读写高出许多。有机构专门做过<a href="https://queue.acm.org/detail.cfm?id=1563874" rel="external nofollow noopener" target="_blank">研究</a> ：</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/disk-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/disk-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/disk-1400.webp"></source> <img src="/assets/img/disk.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Kafka 就是利用了磁盘顺序读写的特性，在 Kafka 底层，消息是保存在 partition 文件中的。为了避免大文件读写，Kafka 将 partition 文件细分为 segment 小文件，每次保存消息都是 <em>追加</em> 到对应文件末尾，而不是随机写入，这使得 Kafka 写入的吞吐量得到显著提高。</p> <p>但这种方式有一个缺陷，就是不能删除数据。因此 Kafka 是不会立即删除消费成功的消息的，它会把所有消息保存下来，消费端根据 Topic 的 offset 数据来读取消息，因此消费端可以根据需要决定从哪里开始读取。</p> <p>Kafka 后台可以配置策略，依据消息时间戳或者文件大小删除旧数据。</p> <h3 id="page-cache">Page Cache</h3> <p>为了优化读写性能， Kafka 利用了操作系统本身的 Page Cache，就是直接利用堆外内存。</p> <h3 id="零拷贝">零拷贝</h3> <p>TODO</p> <h2 id="kafka-的高可用架构">Kafka 的高可用架构</h2> <p>在 2.8.0 版本之前，Kafka 必须绑定 Zookeeter 启动，Zookeeter 负责存储 Kafka 集群的元数据。在 2.8.0 之后， Kafka 移除了对 Zookeeter 的强依赖，集群自身即可管理相关的数据。</p> <blockquote> <p>参考：</p> <ol> <li><a href="https://www.conduktor.io/kafka/kafka-kraft-mode/" rel="external nofollow noopener" target="_blank">Kafka KRaft Mode</a></li> <li><a href="https://www.conduktor.io/kafka/zookeeper-with-kafka/" rel="external nofollow noopener" target="_blank">Zookeeper with Kafka</a></li> <li><a href="https://gitbook.cn/books/5ae1e77197c22f130e67ec4e/index.html" rel="external nofollow noopener" target="_blank">深入浅出理解基于 Kafka 和 ZooKeeper 的分布式消息队列</a></li> <li><a href="https://www.freecodecamp.org/news/apache-kafka-handbook/#consumer-groups-in-kafka" rel="external nofollow noopener" target="_blank">The Apache Kafka Handbook – How to Get Started Using Kafka</a></li> </ol> </blockquote> </article><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"wzm001/wzm001.github.io","data-repo-id":"R_kgDOG5N29g","data-category":"Announcements","data-category-id":"DIC_kwDOG5N29s4CUo0g","data-mapping":"title","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"zh-CN",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Jimmy Wu. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>