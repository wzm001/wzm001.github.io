<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>ElasticSeatch 入门 | Jimmy Wu</title> <meta name="author" content="Jimmy Wu"> <meta name="description" content="介绍 ElasticSeatch 的架构特点和使用场景"> <meta name="keywords" content="Java, 后端, Software Developer"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/icon.png#%20the%20emoji%20used%20as%20the%20favicon%20(alternatively,%20provide%20image%20name%20in%20/assets/img/)"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://wzm001.github.io//blog/2023/es/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "ElasticSeatch 入门",
      "description": "介绍 ElasticSeatch 的架构特点和使用场景",
      "published": "April 10, 2023",
      "authors": [
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Jimmy Wu</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">关于我</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">博客<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">项目</a> </li> <li class="nav-item "> <a class="nav-link" href="/assets/pdf/cv.pdf">简历</a> </li> <li class="nav-item "> <a class="nav-link" href="/assets/pdf/ecv.pdf">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>ElasticSeatch 入门</h1> <p>介绍 ElasticSeatch 的架构特点和使用场景</p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-es">什么是 ES</a></div> </nav> </d-contents> <h1 id="什么是-es">什么是 ES</h1> <p>ES（ElasticSearch）是目前最受欢迎的企业级 <em>搜索引擎</em>。它基于 <code class="language-plaintext highlighter-rouge">Lucene</code> 开发，依赖 JVM 运行。是一个实时的、分布式的搜索分析引擎。</p> <blockquote> <p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/elasticsearch-intro.html" rel="external nofollow noopener" target="_blank">Elasticsearch Guide</a></p> </blockquote> <p>ES 的主要功能包括：</p> <ul> <li>全文检索</li> <li>结构化搜索</li> <li>数据分析</li> </ul> <p>除此之外，ES 结合 Elastic 的其他产品，组成 Elastic Stack（简称 ELK），被广泛应用于大数据近实时分析领域，包括：日志分析、指标监控、信息安全等。</p> <h2 id="es-的基本概念">ES 的基本概念</h2> <p>ES 是一个分布式的搜索引擎，可以对比 Kafka 或者数据库集群去理解它。</p> <h3 id="near-realtime-nrt">Near Realtime (NRT)</h3> <p>近实时。数据提交到 ES 后，几乎立刻就可以被搜索到（延迟约 1 s）。</p> <h3 id="cluster-集群">Cluster 集群</h3> <p>ES 是集群部署的。一个集群包含多个 ES 服务节点，整体对外提供服务。集群通过唯一的名称进行标识，具有相同集群名称的 ES 服务节点会自动组合成一个集群。集群名称可以在配置文件中指定。</p> <h3 id="node-节点">Node 节点</h3> <p>节点是 ES 服务实例，用来存储集群的数据。ES 的数据分布在集群中的所有节点上。因此 ES 具有良好的伸缩性。节点也有自己的名称，默认在启动时会以一个随机的 UUID 字符串前七位字符作为名称。一个节点也被 ES 当作一个集群。</p> <h3 id="role-角色">Role 角色</h3> <p>节点的分工，下面列出一些主要的角色：</p> <ul> <li>主节点（active master）：一般指活跃的主节点。一个集群只能有一个，主要负责对集群的管理，主节点不保存数据；</li> <li>候选节点（master-eligible）：当主节点发生故障时，参与选举，也就是主节点的替代节点；</li> <li>数据节点（data node）：保存已经编入索引的文档的<em>分片(shard)</em>。处理数据相关的操作，如 crud、搜索、聚合。这些操作是 I/O 密集型、内存密集型和 CPU 密集型。监控这些资源并在它们过载时添加更多数据节点非常重要；</li> <li>预处理节点（ingest node）：类似于 logstash 的消息管道，所以也叫 <code class="language-plaintext highlighter-rouge">ingest pipeline</code>，常用语一些数据写入之前的预处理操作；</li> </ul> <h3 id="index-索引">Index 索引</h3> <p>这个是最容易混淆的概念，不要把 ES 的索引理解为数据库的索引。如果对比数据库的话，ES 的索引相当于数据库中的表。ES 的索引用来存放一组业务数据（文档）。索引有唯一的名称，通过名称操作索引。一个集群可以包含任意多个索引。索引是一个逻辑概念，可以类比为 Kafka 的 Topic。</p> <h3 id="type-类型已废弃">Type 类型（已废弃）</h3> <p>ES 7.0 之前的版本支持类型语法，可以自定义类型，此时的类型可以类比为数据库的表，而此时的索引类比为数据库。但这个数据结构比较混乱，数据库中表之间是相互独立的，两个表如果包含相同的字段，是互不影响的。但在 ES 中，如果不同类型包含相同名称的字段，底层使用相同的 Lucene 字段支持，因此在概念上难以理解。并且类型的存在，允许 ES 的索引中存放不同性质（没有共同字段，业务含义不同等）的文档，这会影响 Lucene 压缩文档的能力，因此 ES 官方在 7.0 版本之后去掉了类型的支持。</p> <p>去掉类型后，不同类型的数据推荐存放在不同的索引中。此时索引类比为数据库的表。</p> <h3 id="document-文档">Document 文档</h3> <p>文档是 ES 保存的基础单元，是 JSON 结构的数据。文档类似于数据库表中的一行。文档中包含任意数量的字段，类比于数据库表的列。文档被添加到索引中，之后就可以通过 ES 检索到文档相关的信息。</p> <h3 id="shard-分片">Shard 分片</h3> <p>存放被索引的文档数据。逻辑上是文档添加到索引中，但从物理角度看，文档实际上保存在分片中。分片保存在节点中，分为 <em>主分片(Primary shard)</em> 和 <em>副本分片(Replica shard)</em>。主分片支持读写。副本分片只支持读操作。为了支持高可用，主分片和对应的副本分片不能同时存在于同一个节点中，相同的副本也不能同时存在于同一个节点中。如果我们把索引类比为 Kafka 的主题，那么分片就类似于 Kafka 的分区(Partition)。</p> <p>每个分片都是一个 Lucene 实例。</p> <h3 id="mapping-映射">Mapping 映射</h3> <p>类似于数据库的表结构。映射定义了索引中文档字段的相关属性。索引的映射可以由 ES 根据文档字段自动推断所得，也可以手动创建。映射创建好之后，字段类型和分词器等属性是不可修改的。</p> <p>ES 中的文档字段类型包括 <em>文本类型</em>、 <em>基本数据类型</em>、<em>keyword</em>、<em>日期</em>、<em>对象</em>、<em>聚合数据类型</em>、<em>结构化类型</em>、<em>空间数据类型</em> 等，具体可以查看 ES 的官方文档。</p> <p>下图展示了 ES 集群的整体架构：</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/es-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/es-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/es-1400.webp"></source> <img src="/assets/img/es.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>其中，索引 Index 包含三个主分片，分别是 <code class="language-plaintext highlighter-rouge">P0, P1, P2</code>，每个主分片各自有两个副本分片，这些分片均匀分布在三个节点上组成一个集群，统一对外提供服务。</p> <h2 id="lucene-和-es-是什么关系呢">Lucene 和 ES 是什么关系呢？</h2> <p>对比 MySQL 的结构，Lucene 相当于 ES 的存储引擎，负责处理具体数据的存储和检索。</p> <p>ES 和 Lucene 的整体结构如下图所示：</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/es-lu-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/es-lu-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/es-lu-1400.webp"></source> <img src="/assets/img/es-lu.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <blockquote> <p>参考：<a href="https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/ElasticSearch%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB%E8%AF%A6%E8%A7%A3/14%20%E5%8E%9F%E7%90%86%EF%BC%9AES%E5%8E%9F%E7%90%86%E7%9F%A5%E8%AF%86%E7%82%B9%E8%A1%A5%E5%85%85%E5%92%8C%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84.md" rel="external nofollow noopener" target="_blank">ES原理知识点补充和整体结构</a></p> </blockquote> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"wzm001/wzm001.github.io","data-repo-id":"R_kgDOG5N29g","data-category":"Announcements","data-category-id":"DIC_kwDOG5N29s4CUo0g","data-mapping":"title","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"zh-CN",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Jimmy Wu. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>